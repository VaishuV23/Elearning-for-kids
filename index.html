<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
     <!--
      This page defines a simple single‚Äëpage application for the Kid Speak & Learn
      experience.  The layout borrows visual cues from a modern chat interface
      but is implemented with plain HTML and CSS so it can live alongside the
      existing Firebase/Firestore client logic without requiring a React build
      step.  All identifiers referenced by the accompanying JavaScript are
      preserved (e.g. #chatList, #recordBtn, #textInput) so the original
      behaviour continues to work.
    -->
    <title>Kid Speak &amp; Learn</title>
    <style>
      :root{--card:#fff;--ink:#111;--muted:#666;--bd:#e5e7eb;--bg:#f8fafc;--primary:#111;--primary-contrast:#fff;--accent:#f1f5f9}
      *{box-sizing:border-box}
      html,body{margin:0;padding:0;height:100%;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink);display:flex;flex-direction:column}
      #authBar{display:flex;align-items:center;justify-content:space-between;gap:.5rem;padding:.6rem 1rem;border-bottom:1px solid var(--bd);background:#fff;z-index:10}
      #authBar .user-info{display:flex;align-items:center;gap:.5rem}
      #authBar img{width:28px;height:28px;border-radius:50%;border:1px solid var(--bd);display:none}
      #authBar .user-name{font-weight:600}
      #authBar .user-email{color:var(--muted);font-size:.9rem}
      #authScreen{position:fixed;inset:0;background:radial-gradient(1200px 600px at 10% 0%, #ffffff 60%, #f6f7fb 100%);display:grid;place-items:center;z-index:9999}
      .auth-card{width:min(520px,92vw);background:#fff;border:1px solid var(--bd);border-radius:16px;padding:28px 28px 22px;box-shadow:0 20px 60px rgba(0,0,0,.08);text-align:center}
      .brand{font-weight:800;letter-spacing:.2px;font-size:18px;margin-bottom:6px}
      .auth-title{margin:6px 0 2px;font-size:28px}
      .auth-sub{margin:0 0 16px;color:var(--muted)}
      .auth-stack{display:grid;gap:10px;margin:12px 0}
      .btn-auth{width:100%;padding:12px 14px;border-radius:999px;border:1px solid var(--bd);background:#fff;font-weight:600;cursor:pointer;transition:transform .05s ease,box-shadow .25s ease,border-color .25s ease}
      .btn-auth:hover{box-shadow:0 8px 24px rgba(0,0,0,.06)}
      .btn-auth:active{transform:translateY(1px)}
      .btn-facebook{background:#1877F2;color:#fff;border-color:#1877F2}
      .btn-email{background:#111;color:#fff;border-color:#111}
      .btn-phone{background:#16a34a;color:#fff;border-color:#16a34a}
      .auth-sep{margin:10px 0 6px;display:flex;align-items:center;gap:10px;color:var(--muted)}
      .auth-sep:before,.auth-sep:after{content:"";flex:1;height:1px;background:var(--bd)}
      .auth-sep span{padding:0 6px;font-size:12px;letter-spacing:.3px}
      .auth-foot{margin:14px 0 0;color:var(--muted);font-size:12px}
      .app-container{flex:1;display:flex;min-height:0;overflow:hidden}
      .side{width:280px;background:var(--card);border-right:1px solid var(--bd);display:flex;flex-direction:column;min-height:0}
      .side h1{margin:0;font-size:1.2rem;font-weight:600}
      .side .header{padding:1rem;border-bottom:1px solid var(--bd)}
      .side .header .logo{display:flex;align-items:center;gap:.75rem;margin-bottom:.75rem}
      .side .header .logo-icon{width:32px;height:32px;background:var(--primary);color:var(--primary-contrast);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem}
      .lang-card{cursor:pointer;padding:.5rem .75rem;background:var(--bg);border:1px solid transparent;border-radius:8px;display:flex;align-items:center;justify-content:space-between;transition:background .15s,border-color .15s}
      .lang-card:hover{background:var(--accent);border-color:var(--bd)}
      .lang-settings{margin-top:.75rem;padding:.75rem;background:var(--bg);border:1px solid var(--bd);border-radius:8px}
      .lang-settings label{font-size:.75rem;color:var(--muted);display:block;margin-bottom:.25rem}
      .lang-settings select{width:100%;padding:.5rem;border:1px solid var(--bd);border-radius:6px;background:#fff;font-size:.9rem}
      .chat-list-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem}
      .chatitem{padding:.6rem .7rem;border:1px solid var(--bd);border-radius:10px;background:#fafafa;cursor:pointer;transition:background .15s,border-color .15s}
      .chatitem:hover{background:#f1f5f9}
      .chatitem.active{background:#eef2ff;border-color:#c7d2fe}
      .user-profile{padding:1rem;border-top:1px solid var(--bd);display:flex;align-items:center;gap:.75rem}
      .user-profile .avatar{width:32px;height:32px;border-radius:50%;background:rgba(17,17,17,.1);color:var(--primary);display:flex;align-items:center;justify-content:center;font-size:.9rem}
      .user-profile .info{flex:1;min-width:0}
      .user-profile .info .name{font-size:.9rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .user-profile .info .email{font-size:.75rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      main{flex:1;display:flex;flex-direction:column;min-height:0}
      .status{padding:.5rem 1rem;font-size:.9rem;color:var(--muted)}
      #loadingBar{display:none;width:100%;padding:.6rem;background:#4CAF50;color:#fff;text-align:center;border-radius:8px;margin:0 1rem .5rem;font-weight:600}
      #chatThread{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.75rem;background:var(--bg);border-top:1px solid var(--bd);border-bottom:1px solid var(--bd)}
      .msg{max-width:70%;padding:.6rem 1rem;border-radius:16px;box-shadow:0 2px 4px rgba(0,0,0,.05);line-height:1.4;word-break:break-word;font-size:.95rem}
      .msg.user{align-self:flex-end;background:linear-gradient(135deg,#dbeafe,#c7d2fe);border-top-right-radius:0}
      .msg.assistant{align-self:flex-start;background:linear-gradient(135deg,#fef3c7,#fde68a);border-top-left-radius:0}
      .msg.assistant :is(p,ul,ol,pre,code,blockquote,h1,h2,h3){margin:.25rem 0}
      .msg.assistant pre{padding:.6rem;border-radius:8px;overflow:auto;background:#1111/4}
      .msg.assistant code{padding:.1rem .3rem;border-radius:6px;background:#1111/4}
      .msg.assistant a{color:#0b62ff;text-decoration:none}
      .msg.assistant a:hover{text-decoration:underline}
      #suggestions{display:none;padding:.5rem 1rem;display:flex;flex-wrap:wrap;gap:.5rem}
      .suggestion-btn{padding:.4rem .9rem;border-radius:999px;background:#f1f5f9;border:1px solid var(--bd);cursor:pointer;font-size:.85rem;transition:background .2s}
      .suggestion-btn:hover{background:#e2e8f0}
      #player{margin:0 1rem 1rem;width:calc(100% - 2rem)}
      .input-panel{border-top:1px solid var(--bd);padding:1rem}
      .input-wrapper{position:relative;display:flex;align-items:flex-end;gap:.5rem;padding:.6rem;background:rgba(0,0,0,0.02);border:1px solid var(--bd);border-radius:16px}
      #recordBtn,#pauseBtn,#sendBtn,#sendTextBtn{width:40px;height:40px;border-radius:50%;border:none;background:var(--primary);color:var(--primary-contrast);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem}
      #recordBtn.recording{background:#dc2626;animation:pulse 1s infinite}
      @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
      #sendBtn[disabled],#sendTextBtn[disabled]{opacity:.5;cursor:not-allowed}
      #textInput{flex:1;min-height:24px;max-height:120px;resize:none;border:none;outline:none;background:transparent;font-size:.95rem}
      #timer{position:absolute;top:-1.6rem;left:50%;transform:translateX(-50%);padding:.2rem .6rem;background:#dc2626;color:#fff;border-radius:999px;font-size:.75rem;display:none}
      #transcript,#answer{display:none}
      .mobile-toggle{display:none}
      #mobileHeader{display:none}
      @media (max-width:940px){
        .side{position:fixed;top:0;left:0;width:75%;height:100vh;z-index:999;background:#fff;border-right:1px solid var(--bd);overflow:auto;transition:transform .3s ease-out;transform:translateX(-100%)}
        .side.open{transform:translateX(0)}
        .mobile-toggle{display:inline-block;margin:.5rem 1rem;cursor:pointer;background:var(--card);border:1px solid var(--bd);padding:.5rem .75rem;border-radius:8px}
        #mobileHeader{display:block}
      }
    </style>
  </head>
  <body>
    <!-- Full-screen Auth Screen -->
    <section id="authScreen" style="display:none">
      <div class="auth-card">
        <div class="brand">Kid Speak & Learn</div>
        <h2 class="auth-title">Log in or sign up</h2>
        <p class="auth-sub">You‚Äôll get smarter responses and can upload audio.</p>
        <div class="auth-stack">
          <button id="loginBtn"      class="btn-auth">üîí Continue with Google</button>
          <button id="fbLoginBtn"    class="btn-auth btn-facebook">üìò Continue with Facebook</button>
          <button id="phoneLoginBtn" class="btn-auth btn-phone">üì± Continue with phone</button>
        </div>
        <div class="auth-sep"><span>OR</span></div>
        <button id="emailLoginBtn" class="btn-auth btn-email" style="width:100%">‚úâÔ∏è Continue with email</button>
        <p class="auth-foot">By continuing, you agree to our Terms & Privacy.</p>
      </div>
    </section>

    <!-- Thin top bar -->
    <div id="authBar" style="display:none">
      <div class="user-info">
        <img id="userPhoto" src="" alt="User" />
        <span id="userName" class="user-name"></span>
        <span id="userEmail" class="user-email"></span>
      </div>
      <div id="recaptcha-container"></div>
      <div class="auth-actions">
        <button id="logoutBtn" class="btn-auth" style="padding:.4rem .9rem;border-radius:8px;">üö™ Sign out</button>
      </div>
    </div>

    <div id="loginRequired" style="display:none;text-align:center;margin:1rem 0;padding:1rem;border:1px solid var(--bd);border-radius:12px;background:#fff;">
      Please sign in to start using Kid Speak &amp; Learn.
    </div>

    <button id="toggleSidebarBtn" class="mobile-toggle">Recent Chats</button>

    <div class="app-container">
      <aside class="side" id="sidebar">
        <div class="header">
          <div class="logo">
            <div class="logo-icon">üí¨</div>
            <h1>Kid Speak &amp; Learn</h1>
          </div>
          <div id="langCard" class="lang-card">
            <div style="display:flex;align-items:center;gap:.5rem;">
              <span>üåê</span><span id="langLabel">English ‚Üí English</span>
            </div><span style="font-size:.9rem;">‚ñº</span>
          </div>
          <div id="langSettings" class="lang-settings" style="display:none;">
            <div style="margin-bottom:.75rem;">
              <label for="speakLang">Speaking</label>
              <select id="speakLang" required>
                <option value="">Select language</option>
               <option>English</option>
                <option>Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                <option>Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
                <option>Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
                <option>Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
                <option>Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
                <option>Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
                <option>Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)</option>
                <option>Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
                <option>Panjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)</option>
              </select>
            </div>
            <div>
              <label for="answerLang">Answer</label>
              <select id="answerLang" required>
                <option value="">Select language</option>
                <option>English</option>
                <option>Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                <option>Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
                <option>Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
                <option>Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
                <option>Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
                <option>Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
                <option>Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)</option>
                <option>Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
                <option>Panjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)</option>

              </select>
            </div>
          </div>
        </div>

        <div style="flex:1;overflow-y:auto;padding:1rem;">
          <div class="chat-list-header">
            <h3 style="font-size:.9rem;font-weight:600;color:var(--muted);margin:0;">Recent Chats</h3>
            <div style="display:flex;gap:.4rem;">
              <button id="newChatBtn" title="New chat" style="background:none;border:none;cursor:pointer;font-size:1.2rem;">‚ûï</button>
              <button id="clearAllBtn" title="Delete all chats" style="background:none;border:none;cursor:pointer;font-size:1.2rem;">üóëÔ∏è</button>
            </div>
          </div>
          <div id="chatList" class="chatlist" style="display:flex;flex-direction:column;gap:.5rem;"></div>
        </div>

        <div class="user-profile">
          <div class="avatar" id="userAvatar">üë§</div>
          <div class="info">
            <div class="name" id="profileName"></div>
            <div class="email" id="profileEmail"></div>
          </div>
          <button id="settingsBtn" style="background:none;border:none;cursor:pointer;font-size:1.2rem;color:var(--muted);">‚öôÔ∏è</button>
        </div>
      </aside>

      <main>
        <div id="mobileHeader" class="mobile-header" style="padding:1rem;border-bottom:1px solid var(--bd);">
          <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:.5rem;">
            <div style="width:32px;height:32px;background:var(--primary);color:var(--primary-contrast);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;">üí¨</div>
            <h1 style="margin:0;font-size:1.2rem;font-weight:600;">Kid Speak &amp; Learn</h1>
          </div>
          <div id="mobileLangCard" class="lang-card" style="margin-bottom:.5rem;">
            <div style="display:flex;align-items:center;gap:.5rem;">
              <span>üåê</span><span id="mobileLangLabel">English ‚Üí English</span>
            </div><span style="font-size:.9rem;">‚ñº</span>
          </div>
          <div id="mobileLangSettings" class="lang-settings" style="display:none;">
            <div style="margin-bottom:.75rem;">
              <label for="mobileSpeakLang">Speaking</label>
              <select id="mobileSpeakLang" required>
                <option value="">Select language</option>
                <option>English</option>
                <option>Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                <option>Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
                <option>Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
                <option>Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
                <option>Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
                <option>Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
                <option>Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)</option>
                <option>Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
                <option>Panjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)</option>

              </select>
            </div>
            <div>
              <label for="mobileAnswerLang">Answer</label>
              <select id="mobileAnswerLang" required>
                <option value="">Select language</option>
                <option>English</option>
                <option>Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                <option>Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
                <option>Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
                <option>Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
                <option>Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
                <option>Marathi (‡§Æ‡§∞‡§æ‡§†‡•Ä)</option>
                <option>Gujarati (‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä)</option>
                <option>Bengali (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ)</option>
                <option>Panjabi (‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)</option>
              </select>
            </div>
          </div>
        </div>

        <div id="status" class="status">Choose both languages ‚Üí tap <b>Start recording</b>, type a question or tap <b>Send</b>.</div>
        <div id="loadingBar">We are preparing your answers‚Ä¶</div>
        <div id="chatThread"></div>
        <div id="suggestions"></div>
        <audio id="player" controls></audio>

        <div class="input-panel">
          <div class="input-wrapper">
            <button id="recordBtn" title="Start recording">üéôÔ∏è</button>
            <button id="pauseBtn" title="Pause/Resume" style="display:none">‚è∏</button>
            <textarea id="textInput" placeholder="Type your message here‚Ä¶" rows="1"></textarea>
            <button id="sendBtn" title="Send audio" disabled>üì§</button>
            <button id="sendTextBtn" title="Send text" disabled>‚û§</button>
            <span id="timer">00:00</span>
          </div>
          <div id="voiceActions" style="display:none;gap:.5rem;margin-top:.5rem;">
            <button id="voiceSendBtn"  title="Send recording">üì§ Send</button>
            <button id="voiceDiscardBtn" title="Discard recording">üóëÔ∏è Delete</button>
          </div>
        </div>
      </main>
    </div>

    <div id="transcript"></div>
    <div id="answer"></div>

    <!-- MODULE: Firebase + Auth UI helpers -->
    <script type="module">
      // --- Safe stub so module can run before non-module defines validateLangs() ---
      window.validateLangs = window.validateLangs || function(){ return false; };
      const safeValidate = () => (window.validateLangs ? window.validateLangs() : false);

      import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
      import {
        getAuth, GoogleAuthProvider, FacebookAuthProvider,
        signInWithPopup, signOut, onAuthStateChanged, getIdToken,
        createUserWithEmailAndPassword, signInWithEmailAndPassword,
        RecaptchaVerifier, signInWithPhoneNumber
      } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
      import {
        getFirestore, doc, setDoc, updateDoc, collection, addDoc,
        serverTimestamp, query, orderBy, limit, getDocs, increment,
        writeBatch, getDoc
      } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';

      const firebaseConfig = {
        apiKey: "AIzaSyARKGvFd051nAxe3lXpkcktBHl46NP38A0",
        authDomain: "kid-speak-learn.firebaseapp.com",
        projectId: "kid-speak-learn",
        storageBucket: "kid-speak-learn.firebasestorage.app",
        messagingSenderId: "334841993987",
        appId: "1:334841993987:web:1eebc8a53936d06ed0e736"
      };

      const app  = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db   = getFirestore(app);
      const provider   = new GoogleAuthProvider();
      const fbProvider = new FacebookAuthProvider();

      // Expose for later scripts
      window.__auth = { auth, getIdToken, user: null };
      window.__db   = { db, doc, setDoc, updateDoc, collection, addDoc, serverTimestamp, query, orderBy, limit, getDocs, increment, writeBatch, getDoc  };

      // Refs
      const loginBtn       = document.getElementById('loginBtn');
      const fbLoginBtn     = document.getElementById('fbLoginBtn');
      const phoneLoginBtn  = document.getElementById('phoneLoginBtn');
      const emailLoginBtn  = document.getElementById('emailLoginBtn');
      const logoutBtn      = document.getElementById('logoutBtn');
      const authScreen     = document.getElementById('authScreen');
      const appContainer   = document.querySelector('.app-container');
      const authBar        = document.getElementById('authBar');
      const loginReqEl     = document.getElementById('loginRequired');

      const userNameEl     = document.getElementById('userName');
      const userEmailEl    = document.getElementById('userEmail');
      const userPhotoEl    = document.getElementById('userPhoto');
      const profileNameEl  = document.getElementById('profileName');
      const profileEmailEl = document.getElementById('profileEmail');
      const userAvatarEl   = document.getElementById('userAvatar');

      // Debounce popup logins
      let loggingIn = false;
      loginBtn?.addEventListener('click', async () => {
        if (loggingIn) return; loggingIn = true; loginBtn.disabled = true;
        try { await signInWithPopup(auth, provider); }
        catch (e) { alert('Login failed: ' + (e?.message || e)); }
        finally { loggingIn = false; loginBtn.disabled = false; }
      });

      fbLoginBtn?.addEventListener('click', async () => {
        if (loggingIn) return; loggingIn = true; fbLoginBtn.disabled = true;
        try { await signInWithPopup(auth, fbProvider); }
        catch (e) { alert('Facebook login failed: ' + (e?.message || e)); }
        finally { loggingIn = false; fbLoginBtn.disabled = false; }
      });

      let appVerifier;
      function ensureRecaptcha() {
        if (!appVerifier) {
          appVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { size: 'invisible' });
        }
        return appVerifier;
      }

      phoneLoginBtn?.addEventListener('click', async () => {
        try {
          const phone = prompt('Enter mobile with country code (e.g. +91XXXXXXXXXX):');
          if (!phone) return;
          const verifier = ensureRecaptcha();
          const confirmation = await signInWithPhoneNumber(auth, phone, verifier);
          const code = prompt('Enter the 6-digit OTP you received:');
          if (!code) return;
          await confirmation.confirm(code);
        } catch (e) {
          if (String(e.message || e).includes('captcha')) {
            alert('reCAPTCHA failed. Make sure the page is served over HTTPS and try again.');
          } else if (String(e.code).includes('auth/too-many-requests')) {
            alert('Too many attempts. Wait a few minutes and try again.');
          } else {
            alert('Phone sign-in failed: ' + (e?.message || e));
          }
          try { appVerifier = null; } catch {}
        }
      });

      logoutBtn?.addEventListener('click', async () => {
        try { await signOut(auth); }
        catch (e) { console.error('Sign out failed:', e); }
      });

      // Defensive DOM lookups (module executes before non-module defines globals)
      function enableAppControls(enabled) {
        const textInput   = document.getElementById('textInput');
        const recordBtn   = document.getElementById('recordBtn');
        const sendBtn     = document.getElementById('sendBtn');
        const sendTextBtn = document.getElementById('sendTextBtn');
        const pauseBtn    = document.getElementById('pauseBtn');
        const player      = document.getElementById('player');
        const voiceAct    = document.getElementById('voiceActions');
        const toggleBtn   = document.getElementById('toggleSidebarBtn');

        if (textInput)   textInput.disabled   = !enabled;
        if (recordBtn)   recordBtn.disabled   = !enabled || !safeValidate();
        if (sendTextBtn) sendTextBtn.disabled = !enabled || !(textInput?.value.trim()) || !safeValidate();
        if (pauseBtn)    pauseBtn.disabled    = !enabled;
        if (toggleBtn)   toggleBtn.disabled   = !enabled;

        if (!enabled) {
          try { player.pause(); player.removeAttribute('src'); player.load(); } catch {}
          try { if (voiceAct) voiceAct.style.display = 'none'; } catch {}
        }
      }

      onAuthStateChanged(auth, async (user) => {
        window.__auth.user = user || null;

        if (user) {
          userNameEl.textContent  = user.displayName || '';
          userEmailEl.textContent = user.email || '';
          if (user.photoURL) {
            userPhotoEl.src = user.photoURL;
            userPhotoEl.style.display = '';
          } else userPhotoEl.style.display = 'none';

          profileNameEl.textContent  = user.displayName || '';
          profileEmailEl.textContent = user.email || '';
          if (user.photoURL) {
            userAvatarEl.textContent = '';
            userAvatarEl.style.backgroundImage = `url(${user.photoURL})`;
            userAvatarEl.style.backgroundSize = 'cover';
            userAvatarEl.style.backgroundPosition = 'center';
          } else {
            userAvatarEl.style.backgroundImage = '';
            userAvatarEl.textContent = 'üë§';
          }

          authScreen.style.display   = 'none';
          appContainer.style.display = '';
          authBar.style.display      = '';
          loginReqEl.style.display   = 'none';

          try { if (window.syncChatsFromFirestore) await window.syncChatsFromFirestore(user.uid); } catch {}
          enableAppControls(true);
        } else {
          userNameEl.textContent  = '';
          userEmailEl.textContent = '';
          userPhotoEl.style.display = 'none';
          profileNameEl.textContent  = '';
          profileEmailEl.textContent = '';
          userAvatarEl.style.backgroundImage = '';
          userAvatarEl.textContent = 'üë§';

          authScreen.style.display   = 'grid';
          appContainer.style.display = 'none';
          authBar.style.display      = 'none';
          loginReqEl.style.display   = 'none';

          enableAppControls(false);
          window.__auth.lastIdToken = null;
        }
      });

      // Lang card toggles (module side)
      const langCard = document.getElementById('langCard');
      const langSettings = document.getElementById('langSettings');
      const langLabel = document.getElementById('langLabel');
      langCard?.addEventListener('click', ()=>{
        const open = langSettings.style.display !== 'none';
        langSettings.style.display = open ? 'none' : 'block';
      });

      const speakSelect  = document.getElementById('speakLang');
      const answerSelect = document.getElementById('answerLang');

      const LANG_KEY = "kid_lang_v1";
      function saveLangPrefs() {
        const data = { speak: speakSelect.value || "", answer: answerSelect.value || "" };
        localStorage.setItem(LANG_KEY, JSON.stringify(data));
      }
      window.loadLangPrefs = function(){
        try {
          const data = JSON.parse(localStorage.getItem(LANG_KEY));
          if (!data) return;
          if (data.speak) {
            speakSelect.value = data.speak;
            const mobileSpeakSel = document.getElementById('mobileSpeakLang');
            if (mobileSpeakSel) mobileSpeakSel.value = data.speak;
          }
          if (data.answer) {
            answerSelect.value = data.answer;
            const mobileAnsSel = document.getElementById('mobileAnswerLang');
            if (mobileAnsSel) mobileAnsSel.value = data.answer;
          }
          updateLangLabel();
        } catch {}
      }

      window.updateLangLabel = function(){
        const speak = speakSelect.value || 'Speaking';
        const ans   = answerSelect.value || 'Answer';
        langLabel.textContent = speak + ' ‚Üí ' + ans;
        const mobileLabel = document.getElementById('mobileLangLabel');
        if (mobileLabel) mobileLabel.textContent = speak + ' ‚Üí ' + ans;
      }

      function safeValidateAndSave(){ safeValidate(); saveLangPrefs(); }

      speakSelect?.addEventListener('change', ()=>{
        const mobileSpeak = document.getElementById('mobileSpeakLang');
        if (mobileSpeak && mobileSpeak.value !== speakSelect.value) mobileSpeak.value = speakSelect.value;
        updateLangLabel(); safeValidateAndSave();
      });
      answerSelect?.addEventListener('change', ()=>{
        const mobileAnswer = document.getElementById('mobileAnswerLang');
        if (mobileAnswer && mobileAnswer.value !== answerSelect.value) mobileAnswer.value = answerSelect.value;
        updateLangLabel(); safeValidateAndSave();
      });

      const mobileLangCard = document.getElementById('mobileLangCard');
      const mobileLangSettings = document.getElementById('mobileLangSettings');
      mobileLangCard?.addEventListener('click', ()=>{
        const open = mobileLangSettings.style.display !== 'none';
        mobileLangSettings.style.display = open ? 'none' : 'block';
      });
      const mobileSpeak = document.getElementById('mobileSpeakLang');
      const mobileAnswer = document.getElementById('mobileAnswerLang');

      function updateMobileLangLabel() {
        const speak = mobileSpeak.value || 'Speaking';
        const ans   = mobileAnswer.value || 'Answer';
        const mobileLabel = document.getElementById('mobileLangLabel');
        if (mobileLabel) mobileLabel.textContent = speak + ' ‚Üí ' + ans;
      }
      mobileSpeak?.addEventListener('change', ()=>{
        if (speakSelect.value !== mobileSpeak.value) {
          speakSelect.value = mobileSpeak.value;
          updateLangLabel(); safeValidate();
        }
        updateMobileLangLabel();
      });
      mobileAnswer?.addEventListener('change', ()=>{
        if (answerSelect.value !== mobileAnswer.value) {
          answerSelect.value = mobileAnswer.value;
          updateLangLabel(); safeValidate();
        }
        updateMobileLangLabel();
      });

      // Expose sync function name for optional call above
      window.syncChatsFromFirestore = async function(uid){ /* no-op placeholder */ };
    </script>

    <!-- Non-module libs -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <script>
      function renderMD(mdText){
        const normalized=(mdText||"").replace(/\r\n/g,"\n");
        const html=marked.parse(normalized,{breaks:true,gfm:true});
        return DOMPurify.sanitize(html);
      }
    </script>

    <!-- APP logic (non-module) -->
    <script>
      const API_BASE = "https://elearning-for-kids.onrender.com";

      // ---------- DOM ----------
      const chatList    = document.getElementById('chatList');
      const newChatBtn  = document.getElementById('newChatBtn');
      const recordBtn   = document.getElementById('recordBtn');
      const pauseBtn    = document.getElementById('pauseBtn');
      const sendBtn     = document.getElementById('sendBtn');
      const statusEl    = document.getElementById('status');
      const transcriptEl= document.getElementById('transcript');
      const answerEl    = document.getElementById('answer');
      const player      = document.getElementById('player');
      const speakLangSel= document.getElementById('speakLang');
      const answerLangSel=document.getElementById('answerLang');
      const timerBadge  = document.getElementById('timer');
      const loadingBar  = document.getElementById('loadingBar');
      const textInput   = document.getElementById('textInput');
      const sendTextBtn = document.getElementById('sendTextBtn');

      // ---------- Local storage helpers ----------
      const LS_KEY = "kid_chats_v1";
      function loadAllChats(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || []; }catch{ return []; } }
      function saveAllChats(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }
      function createChat(){
        const id = crypto.randomUUID();
        const chat = { id, title: "New chat", createdAt: Date.now(), messages: [] };
        const list = loadAllChats(); list.unshift(chat); saveAllChats(list);
        const user = window.__auth?.user;
        if (user) createFirestoreChat(user.uid, id, chat.title);
        return chat;
      }
      function getChat(id){ return loadAllChats().find(c=>c.id===id); }
      function updateChat(chat){
        const list = loadAllChats();
        const idx = list.findIndex(c=>c.id===chat.id);
        if (idx>=0){ list[idx]=chat; } else { list.unshift(chat); }
        saveAllChats(list);
      }
      function deleteChat(id){
        if (!id) return;
        if (!confirm('Delete this chat? This cannot be undone.')) return;
        const list = loadAllChats().filter(c=>c.id!==id);
        saveAllChats(list);
        const user = window.__auth?.user;
        if (user) { deleteFirestoreChat(user.uid, id).catch(e=>console.warn('Firestore delete failed:',e)); }
        if (currentChatId===id){
          if (list.length){ currentChatId=list[0].id; loadChat(currentChatId); }
          else { const c=createChat(); loadChat(c.id); }
        } else renderChatList();
        statusEl.textContent='Chat deleted.';
      }
      function deleteAllChats(){
        if (!confirm('Delete ALL chats? This cannot be undone.')) return;
        saveAllChats([]);
        const user = window.__auth?.user;
        if (user){
          (async()=>{
            try{
              const { db, collection, getDocs } = window.__db;
              const chatsCol = collection(db,'users',user.uid,'chats');
              const snap = await getDocs(chatsCol);
              for (const docSnap of snap.docs){ await deleteFirestoreChat(user.uid, docSnap.id); }
            }catch(e){ console.warn('Firestore clear all failed:',e); }
          })();
        }
        const c=createChat(); loadChat(c.id);
        statusEl.textContent='All chats cleared.';
      }

      function setTitleIfEmpty(chat, firstUserText){
        if (!firstUserText) return;
        if (chat.title==="New chat" || !chat.title){
          chat.title = firstUserText.slice(0,40) + (firstUserText.length>40 ? "‚Ä¶" : "");
        }
      }

      // Firestore helpers
      async function createFirestoreChat(uid, chatId, title){
        const { db, doc, setDoc, serverTimestamp } = window.__db;
        try {
          const chatRef = doc(db,'users',uid,'chats',chatId);
          await setDoc(chatRef,{ title, createdAt: serverTimestamp(), updatedAt: serverTimestamp(), lastSnippet: '' },{ merge:true });
        } catch(e){ console.error('Failed to create chat in Firestore', e); }
      }
      async function saveTurnToFirestore(uid, chatId, userText, assistantText, speakLang, answerLang){
        const { db, doc, setDoc, updateDoc, collection, addDoc, serverTimestamp, increment, writeBatch } = window.__db;
        try {
          const chatRef = doc(db,'users',uid,'chats',chatId);
          const msgsCol = collection(db,'users',uid,'chats',chatId,'messages');
          await setDoc(chatRef,{
            title: (userText&&userText.trim()) ? userText.trim().slice(0,40)+(userText.trim().length>40?'‚Ä¶':'') : 'Chat',
            createdAt: serverTimestamp(),
          },{ merge:true });

          const batch = writeBatch(db); let wroteCount=0;
          if (userText){
            const userMsgRef = doc(msgsCol);
            batch.set(userMsgRef,{ role:'user', content:userText, speakLanguage:speakLang, answerLanguage:answerLang, createdAt:serverTimestamp() });
            wroteCount++;
          }
          if (assistantText){
            const asstMsgRef = doc(msgsCol);
            batch.set(asstMsgRef,{ role:'assistant', content:assistantText, speakLanguage:speakLang, answerLanguage:answerLang, createdAt:serverTimestamp() });
            batch.update(chatRef,{ updatedAt:serverTimestamp(), lastSnippet:(assistantText||'').slice(0,120) });
            wroteCount++;
          }
          if (wroteCount>0){ batch.update(chatRef,{ messageCount: increment(wroteCount) }); }
          await batch.commit();
        } catch(e){ console.error('Failed to save turn to Firestore', e); }
      }
      async function deleteFirestoreChat(uid, chatId){
        const { db, collection, getDocs, doc } = window.__db;
        const msgsCol = collection(db,'users',uid,'chats',chatId,'messages');
        const snap = await getDocs(msgsCol);
        const batchDeletes=[]; snap.forEach(m=>batchDeletes.push(m.ref.delete?m.ref.delete():null));
        await Promise.all(batchDeletes);
        const chatRef = doc(db,'users',uid,'chats',chatId);
        try { const { deleteDoc } = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js'); await deleteDoc(chatRef); }
        catch(e){ const { deleteDoc } = window.__db; await deleteDoc(chatRef); }
      }

      // User memory helpers
      // load user memory
async function loadUserMemory(uid) {
  const { db, doc, getDoc } = window.__db;   // use the initialized db + helpers
  const ref = doc(db, 'users', uid, 'meta', 'memory');
  const snap = await getDoc(ref);
  return snap.exists() ? snap.data() : {};
}

// save user memory
async function saveUserMemory(uid, patch) {
  const { db, doc, setDoc } = window.__db;
  const ref = doc(db, 'users', uid, 'meta', 'memory');
  await setDoc(ref, patch, { merge: true });
}

// load chat summary
async function loadChatSummary(uid, chatId) {
  const { db, doc, getDoc } = window.__db;
  const ref = doc(db, 'users', uid, 'chats', chatId);
  const snap = await getDoc(ref);
  return snap.exists() ? (snap.data().summary || '') : '';
}

// save chat summary
async function saveChatSummary(uid, chatId, summary) {
  const { db, doc, updateDoc, setDoc, serverTimestamp } = window.__db;
  const ref = doc(db, 'users', uid, 'chats', chatId);
  try {
    await updateDoc(ref, { summary, updatedAt: serverTimestamp() });
  } catch {
    await setDoc(ref, { summary, updatedAt: serverTimestamp() }, { merge: true });
  }
}


      // ---------- UI: render chat list ----------
      let currentChatId = null;
      function renderChatList(){
        const list=loadAllChats(); chatList.innerHTML="";
        list.forEach(chat=>{
          const div=document.createElement("div");
          div.className="chatitem"+(chat.id===currentChatId?" active":"");
          const d=new Date(chat.createdAt);
          const when=d.toLocaleDateString()+" "+d.toLocaleTimeString();
          div.innerHTML=`
            <div style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;">
              <div>
                <div style="font-weight:600">${chat.title}</div>
                <div style="font-size:.85rem;color:#666">${when}</div>
              </div>
              <button class="chat-del" title="Delete this chat" style="background:none;border:none;cursor:pointer;font-size:1.1rem;">üóëÔ∏è</button>
            </div>`;
          div.onclick=()=>loadChat(chat.id);
          const delBtn=div.querySelector('.chat-del');
          delBtn.addEventListener('click',(e)=>{ e.stopPropagation(); deleteChat(chat.id); });
          chatList.appendChild(div);
        });
      }
      function loadChat(id){
        currentChatId=id; renderChatList();
        const chat=getChat(id);
        if (chat && chat.messages.length){
          const lastUser=[...chat.messages].reverse().find(m=>m.role==="user");
          const lastAsst=[...chat.messages].reverse().find(m=>m.role==="assistant");
          transcriptEl.textContent=lastUser?.content || "‚Äî";
          answerEl.textContent=lastAsst?.content || "‚Äî";
        } else { transcriptEl.textContent="‚Äî"; answerEl.textContent="‚Äî"; }
        player.removeAttribute("src"); player.load();
        loadingBar.style.display="none";
        statusEl.textContent="Loaded chat. Record a follow-up, type a question or start a New chat.";
        lastBlob=null;
        validateLangs();
        renderThread();
      }
      (function initChats(){
        const all=loadAllChats();
        if (all.length===0){ const c=createChat(); currentChatId=c.id; }
        else { currentChatId=all[0].id; }
        renderChatList();
      })();
      newChatBtn.addEventListener('click', ()=>{ const c=createChat(); loadChat(c.id); });
      document.getElementById('clearAllBtn').addEventListener('click', deleteAllChats);

      // ---------- Recording ----------
      let mediaRecorder, chunks=[], isRecording=false, startTs=0, tickInt=null, lastBlob=null;
      function validateLangs(){
        const ok = speakLangSel.value && answerLangSel.value;
        recordBtn.disabled = !ok || !window.__auth?.user;
        sendBtn.disabled   = !ok || !lastBlob || !window.__auth?.user;
        sendTextBtn.disabled = !ok || !window.__auth?.user || !textInput.value.trim();
        return ok;
      }
      speakLangSel.addEventListener('change', validateLangs);
      answerLangSel.addEventListener('change', validateLangs);
      textInput.addEventListener('input', validateLangs);

      async function getStream(){ try{ return await navigator.mediaDevices.getUserMedia({audio:true}); }catch{ alert("Microphone permission is required."); throw new Error("no-mic"); } }
      function fmt(sec){const m=String(Math.floor(sec/60)).padStart(2,'0');const s=String(Math.floor(sec%60)).padStart(2,'0');return `${m}:${s}`;}
      function startTimer(){timerBadge.style.display='inline-block';startTs=Date.now();tickInt=setInterval(()=>{timerBadge.textContent=fmt((Date.now()-startTs)/1000);},250);}
      function stopTimer(){clearInterval(tickInt);tickInt=null;timerBadge.style.display='none';}

      async function toggleRecording(){
        if (!window.__auth?.user){ statusEl.textContent="Please sign in first."; return; }
        if (!validateLangs()){ statusEl.textContent="Please select both languages first."; return; }
        if (!isRecording){
          statusEl.textContent='Recording‚Ä¶';
          const stream=await getStream();
          chunks=[]; mediaRecorder=new MediaRecorder(stream,{ mimeType:'audio/webm;codecs=opus' });
          mediaRecorder.ondataavailable=e=>{ if(e.data&&e.data.size) chunks.push(e.data); };
          mediaRecorder.onstop=()=>{
            const blob=new Blob(chunks,{type:'audio/webm'}); lastBlob=blob;
            if (blob.size<5000){ statusEl.textContent='Too short. Record at least 1 second.'; sendBtn.disabled=true; voiceActions.style.display='none'; }
            else { statusEl.textContent='Recording saved. Tap Send or Delete.'; sendBtn.disabled=!validateLangs(); voiceActions.style.display='flex'; }
          };
          mediaRecorder.start(); isRecording=true; recordBtn.textContent="‚èπ"; recordBtn.classList.add('recording');
          pauseBtn.style.display='inline-flex'; pauseBtn.disabled=false; pauseBtn.textContent="‚è∏";
          startTimer();
        } else {
          stopTimer(); statusEl.textContent='Processing recording‚Ä¶';
          isRecording=false; recordBtn.textContent="üéôÔ∏è"; recordBtn.classList.remove('recording');
          pauseBtn.style.display='none'; pauseBtn.disabled=true;
          try{ mediaRecorder.stop(); }catch{}
        }
      }
      recordBtn.addEventListener('click', toggleRecording);

      // Long-press
      let pressTimer=null, didStartByLongPress=false;
      function startRecordingNow(){ didStartByLongPress=true; if(!isRecording) toggleRecording(); }
      function stopRecordingNow(){ if(isRecording) toggleRecording(); }
      function handlePressStart(e){ if(!window.__auth?.user){ statusEl.textContent="Please sign in first."; return; } if(!validateLangs()){ statusEl.textContent="Please select both languages."; return; } e.preventDefault(); didStartByLongPress=false; pressTimer=setTimeout(startRecordingNow,300); }
      function handlePressEnd(e){ e.preventDefault(); clearTimeout(pressTimer); pressTimer=null; if(didStartByLongPress){ stopRecordingNow(); } }
      function handlePressCancel(){ clearTimeout(pressTimer); pressTimer=null; }
      recordBtn.addEventListener('mousedown',handlePressStart);
      recordBtn.addEventListener('mouseup',handlePressEnd);
      recordBtn.addEventListener('mouseleave',handlePressCancel);
      recordBtn.addEventListener('touchstart',handlePressStart,{passive:false});
      recordBtn.addEventListener('touchend',handlePressEnd);
      recordBtn.addEventListener('touchcancel',handlePressCancel);

      const voiceActions = document.getElementById('voiceActions');
      document.getElementById('voiceSendBtn').addEventListener('click', async()=>{ await sendAudio(); voiceActions.style.display='none'; });
      document.getElementById('voiceDiscardBtn').addEventListener('click', ()=>{ lastBlob=null; sendBtn.disabled=true; statusEl.textContent='Recording discarded.'; voiceActions.style.display='none'; });

      pauseBtn.addEventListener('click', ()=>{
        if (!mediaRecorder) return;
        if (mediaRecorder.state==='recording'){ mediaRecorder.pause(); pauseBtn.textContent="‚ñ∂Ô∏è"; statusEl.textContent='Paused. Resume or Stop.'; }
        else if (mediaRecorder.state==='paused'){ mediaRecorder.resume(); pauseBtn.textContent="‚è∏"; statusEl.textContent='Recording‚Ä¶'; }
      });

      function getHistoryForCurrentChat(limitTurns=6){
        const chat=getChat(currentChatId); if(!chat) return [];
        const msgs=chat.messages||[]; return msgs.slice(-limitTurns*2);
      }
      function appendTurnToChat(userText, assistantText){
        const chat=getChat(currentChatId); if(!chat) return;
        if (userText) chat.messages.push({role:"user",content:userText});
        if (assistantText) chat.messages.push({role:"assistant",content:assistantText});
        setTitleIfEmpty(chat, userText); updateChat(chat); renderChatList();
        const user=window.__auth?.user;
        if (user) saveTurnToFirestore(user.uid, chat.id, userText, assistantText, speakLangSel.value, answerLangSel.value);
        renderThread();
      }
      async function getAuthHeader(){
        const user=window.__auth?.user; if(!user) return {};
        try{ const token=await window.__auth.getIdToken(user,false); return { 'Authorization':'Bearer '+token }; }
        catch{ return {}; }
      }

      // --- Single JSON-aware SSE reader (keep one) ---
      async function readSSEStream(res, onEvent){
        if (!res || !res.body) throw new Error('No response body to read');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const reader=res.body.getReader(); const decoder=new TextDecoder(); let buf='';
        while(true){
          const { value, done } = await reader.read(); if (done) break;
          buf += decoder.decode(value,{stream:true});
          const frames = buf.split('\n\n'); buf = frames.pop() || '';
          for (const frame of frames){
            const lines = frame.split('\n').map(l=>l.replace(/^data:\s?/, '')).filter(Boolean);
            for (const line of lines){
              let evt=null; try{ evt=JSON.parse(line); }catch{}
              if (evt){ onEvent(evt); continue; }
              onEvent({ type:'delta', delta: line });
            }
          }
        }
      }

      // --- streaming UI helpers ---
      function createStreamingAssistantBubble(){
        const threadEl=document.getElementById('chatThread');
        const div=document.createElement('div'); div.className='msg assistant'; div.__mdBuffer=''; div.innerHTML='';
        threadEl.appendChild(div);
        const observer=new MutationObserver(()=>{ threadEl.scrollTop=threadEl.scrollHeight; });
        observer.observe(div,{childList:true,characterData:true,subtree:true});
        return { el:div, observer };
      }
      function appendDelta(bubble, delta){
        bubble.el.__mdBuffer += (delta||'');
        if (bubble.__raf) cancelAnimationFrame(bubble.__raf);
        bubble.__raf = requestAnimationFrame(()=>{ bubble.el.innerHTML = renderMD(bubble.el.__mdBuffer); });
      }

      async function sendAudio(){
        if (!window.__auth?.user){ statusEl.textContent="Please sign in first."; return; }
        if (!lastBlob){ statusEl.textContent="Please record something first."; return; }
        if (!validateLangs()){ statusEl.textContent="Please select both languages."; return; }

        player.style.display='none'; loadingBar.style.display='block'; statusEl.textContent="";

        const threadEl=document.getElementById('chatThread');
        const userBubble=document.createElement('div'); userBubble.className='msg user';
        userBubble.textContent='üé§ (processing transcript‚Ä¶)'; threadEl.appendChild(userBubble);
        threadEl.scrollTop=threadEl.scrollHeight;

        const fd=new FormData();
        const uid=window.__auth.user.uid;
        const [memory, chatSummary] = await Promise.all([ loadUserMemory(uid), loadChatSummary(uid, currentChatId) ]);

        fd.append('audio', lastBlob, 'speech.webm');
        fd.append('speakLanguage', speakLangSel.value);
        fd.append('answerLanguage', answerLangSel.value);
        fd.append('conversationId', currentChatId);
        fd.append('history', JSON.stringify(getHistoryForCurrentChat(6)));
        fd.append('uid', uid);
        fd.append('memory', JSON.stringify(memory||{}));
        fd.append('chatSummary', JSON.stringify(chatSummary||''));

        try{
          const headers = await getAuthHeader();
          const res = await fetch(`${API_BASE}/api/ask`, { method:'POST', headers:{ ...headers, 'Accept':'text/event-stream' }, body: fd });

          const bubble = createStreamingAssistantBubble();
          let assistantFull=''; let userTranscript='';

          await readSSEStream(res, (evt)=>{
            switch(evt.type){
              case 'delta': {
                const d=evt.delta||''; assistantFull+=d; appendDelta(bubble,d); statusEl.textContent='Thinking‚Ä¶'; break;
              }
              case 'tts':
                if (evt.audioBase64){ player.src='data:audio/mpeg;base64,'+evt.audioBase64; player.style.display='block'; player.play().catch(()=>{}); }
                break;
              case 'done': {
                userTranscript=(evt.transcript || '(voice message)').trim();
                userBubble.textContent=userTranscript;
                transcriptEl.textContent=userTranscript; answerEl.textContent=assistantFull;
                appendTurnToChat(userTranscript, assistantFull);

                // memory patch (inside function)
                const patch={};
                if (!memory?.speakLanguage && speakLangSel.value) patch.speakLanguage=speakLangSel.value;
                if (!memory?.answerLanguage && answerLangSel.value) patch.answerLanguage=answerLangSel.value;
                const m=userTranscript.match(/my name is\s+([A-Za-z][A-Za-z\s'-]{1,40})/i); if (m) patch.name=m[1].trim();
                if (Object.keys(patch).length) saveUserMemory(uid, patch);

                // rolling chat summary
                const chat=getChat(currentChatId);
                if (chat && chat.messages?.length){
                  const lastK=chat.messages.slice(-8).map(m=>`${m.role}: ${m.content}`).join('\n');
                  const naiveSummary=(lastK.length>480? lastK.slice(0,480)+'‚Ä¶':lastK);
                  saveChatSummary(uid,currentChatId,naiveSummary);
                }

                loadingBar.style.display='none';
                updateSuggestions(evt.suggestions || []);
                statusEl.textContent='Done! Ask a follow-up or switch chats.';
                lastBlob=null; recordBtn.textContent="üéôÔ∏è"; recordBtn.classList.remove('recording');
                sendBtn.disabled=true; pauseBtn.style.display='none'; pauseBtn.disabled=true;
                break;
              }
              case 'error': throw new Error(evt.message || 'Stream error');
            }
          });
        }catch(e){
          console.error(e); loadingBar.style.display='none'; statusEl.textContent="Network error. Try again.";
        }
      }
      sendBtn.addEventListener('click', sendAudio);

      async function sendText(){
        if (!window.__auth?.user){ statusEl.textContent="Please sign in first."; return; }
        const textVal=textInput.value.trim(); if (!textVal){ statusEl.textContent="Please type something first."; return; }
        if (!validateLangs()){ statusEl.textContent="Please select both languages."; return; }

        textInput.value=""; player.style.display='none'; loadingBar.style.display='block'; statusEl.textContent="";
        appendTurnToChat(textVal, null);
        const bubble=createStreamingAssistantBubble();

        const uid=window.__auth.user.uid;
        const [memory, chatSummary] = await Promise.all([ loadUserMemory(uid), loadChatSummary(uid, currentChatId) ]);

        const body={
          text: textVal,
          speakLanguage: speakLangSel.value,
          answerLanguage: answerLangSel.value,
          conversationId: currentChatId,
          history: getHistoryForCurrentChat(6),
          uid,
          memory, chatSummary
        };

        try{
          const headers = Object.assign({ 'Content-Type':'application/json', 'Accept':'text/event-stream' }, await getAuthHeader());
          const res = await fetch(`${API_BASE}/api/ask`, { method:'POST', headers, body: JSON.stringify(body) });
          if (!res.ok){ loadingBar.style.display='none'; let msg='Request failed'; try{ msg=(await res.json())?.message||msg; }catch{} statusEl.textContent=msg; return; }

          let assistantFull='';
          await readSSEStream(res, (evt)=>{
            switch(evt.type){
              case 'delta': {
                const d=evt.delta||''; assistantFull+=d; appendDelta(bubble,d); statusEl.textContent='Thinking‚Ä¶'; break;
              }
              case 'tts':
                if (evt.audioBase64){ player.src='data:audio/mpeg;base64,'+evt.audioBase64; player.style.display='block'; }
                break;
              case 'done': {
                appendTurnToChat(null, assistantFull);
                transcriptEl.textContent=textVal; answerEl.textContent=assistantFull; loadingBar.style.display='none';
                updateSuggestions(evt.suggestions || []); statusEl.textContent='Done! Ask a follow-up or switch chats.'; textInput.value=''; validateLangs();

                // memory patch (inside function)
                const patch={};
                if (!memory?.speakLanguage && speakLangSel.value) patch.speakLanguage=speakLangSel.value;
                if (!memory?.answerLanguage && answerLangSel.value) patch.answerLanguage=answerLangSel.value;
                const m=textVal.match(/my name is\s+([A-Za-z][A-Za-z\s'-]{1,40})/i); if (m) patch.name=m[1].trim();
                if (Object.keys(patch).length) saveUserMemory(uid, patch);

                const chat=getChat(currentChatId);
                if (chat && chat.messages?.length){
                  const lastK=chat.messages.slice(-8).map(m=>`${m.role}: ${m.content}`).join('\n');
                  const naiveSummary=(lastK.length>480? lastK.slice(0,480)+'‚Ä¶':lastK);
                  saveChatSummary(uid,currentChatId,naiveSummary);
                }
                break;
              }
              case 'error': throw new Error(evt.message || 'Stream error');
            }
          });
        }catch(e){
          console.error(e); loadingBar.style.display='none'; statusEl.textContent="Network error. Try again.";
        }
      }
      sendTextBtn.addEventListener('click', sendText);
      textInput.addEventListener('keypress',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendText(); } });

      function renderThread(){
        const threadEl=document.getElementById('chatThread'); threadEl.innerHTML='';
        const chat=getChat(currentChatId);
        if (!chat || !chat.messages || !chat.messages.length) return;
        chat.messages.forEach(msg=>{
          const div=document.createElement('div');
          const isAssistant = msg.role!=='user';
          div.className='msg '+(isAssistant?'assistant':'user');
          if (isAssistant) div.innerHTML = renderMD(msg.content || "");
          else div.textContent = msg.content || "";
          threadEl.appendChild(div);
        });
        setTimeout(()=>{ threadEl.scrollTop=threadEl.scrollHeight; },0);
      }

      function updateSuggestions(suggestions=[]){
        const suggestionsEl=document.getElementById('suggestions');
        const prompts=(Array.isArray(suggestions)&&suggestions.length)? suggestions : [
          'Can you give me another example?',
          'Could you explain this in simpler words?',
          'What else should I know about this topic?'
        ];
        suggestionsEl.innerHTML='';
        prompts.forEach(p=>{
          const btn=document.createElement('button');
          btn.className='suggestion-btn'; btn.textContent=p;
          btn.addEventListener('click',()=>{ textInput.value=p; sendText(); });
          suggestionsEl.appendChild(btn);
        });
        suggestionsEl.style.display='flex';
      }

      const toggleBtn=document.getElementById('toggleSidebarBtn');
      const sidebar=document.getElementById('sidebar');
      toggleBtn.addEventListener('click', ()=>{
        const open=sidebar.classList.contains('open');
        if (open){ sidebar.classList.remove('open'); document.body.style.overflow=''; }
        else { sidebar.classList.add('open'); document.body.style.overflow='hidden'; }
      });

      window.addEventListener('load', ()=>{
        loadLangPrefs?.();
        const all=loadAllChats(); if (all.length>0) loadChat(all[0].id);
        validateLangs(); renderThread(); updateLangLabel?.();
        const mSpeak=document.getElementById('mobileSpeakLang');
        const mAns=document.getElementById('mobileAnswerLang');
        if (mSpeak) mSpeak.value=speakLangSel.value;
        if (mAns)   mAns.value=answerLangSel.value;
        const mobileLabel=document.getElementById('mobileLangLabel');
        if (mobileLabel) mobileLabel.textContent=(speakLangSel.value||'Speaking')+' ‚Üí '+(answerLangSel.value||'Answer');
      });
    </script>
  </body>
</html>


